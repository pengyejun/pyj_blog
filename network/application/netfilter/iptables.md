### 前言

一直对iptables不太了解，在一次业务需求中，需要使用iptables进行流量控制，因此重新系统学习了iptables的原理以及使用方法。


### iptables基础

规则(rules)其实就是网络管理员预定义的条件，规则一般的定义为“如果数据包头符合这样的条件，那就按照规则处理这个数据包”。规则存储在内核空间的包过滤表中，这些规则分别指定了源地址、目的地址、传输协议(TCP、UDP、ICMP)、应用类型(HTTP、FTP、SMTP等)。当数据包与规则匹配时，iptables就根据规则所定义的方法来处理这些数据包，如放行(accept)、拒绝(reject)、丢弃(drop)等。配置防护墙就是添加、修改、删除这些规则。

### iptables传输数据包的过程

- 当一个数据包进入网卡时，首先进入PREROUTING链，内核根据数据包的目的IP判断是否需要转发出去。
- 如果数据包是本机的，它就会沿着图向下移动，到达INPUT链。数据包到了INPUT链之后，任何进程都会收到它。本机上运行的程序可以发送数据包，这些数据包会经过OUTPUT链，然后到达POSTROUTING链输出。
- 如果数据包是转发出去的，且内核允许转发，数据包就会如图所示向右移动，经过FORWARD链，然后到达POSTROUTING链输出。
 
![iptables链](./iptables链.png)

### iptables的规则表和链

- 表(tables)提供了特定的功能，iptables内置了4个表，即filter(包过滤)、nat(网络地址转换)、mangle(包重构)、raw(数据跟踪处理)表。
- 链(chains)是数据包传播的路径，每一条规则链其实就是众多规则中的一个检查清单，每一条链中可以有一条或多条规则，当一个数据包到达一个链时，iptables就会从链中第一条规则开始检查，若数据包满足所定义规则的条件，则会根据该规则的方法处理数据包；否则iptables将继续检查下一条规则，如果该数据包不符合链中任一条规则，iptables就会根据该链预先定义的默认策略来处理数据包。
- iptables采用“表”和“链“的分层结构。在REHL4中是三张表五个链。现在REHL5成了四张表五个链，多出了一个RAW表。


  